<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flash Royale</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: url('flash-royale-bg.png') no-repeat center center fixed;
      background-size: cover;
      width: 100%;
      height: 100%;
      color: white;
      user-select: none;
      overflow: hidden;
    }
    .top-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(10,15,30,0.7);border-bottom:3px solid #1e3d59;font-size:14px;}
    .currency{display:flex;gap:15px;}
    .currency div{background:#2d3e50;padding:5px 12px;border-radius:8px;display:flex;align-items:center;gap:5px;}
    .screen{display:none;padding:20px;}
    #menuScreen{display:block;text-align:center;}
    .battle-btn{background:#ffcc00;padding:20px 60px;border-radius:20px;font-size:32px;color:black;cursor:pointer;margin-top:20px;border:3px solid #fff;box-shadow:0 0 25px rgba(255,255,0,0.9);}
    .cancel-btn{background:#ff4444;padding:15px 40px;border-radius:15px;font-size:24px;color:white;cursor:pointer;margin-top:20px;border:3px solid #fff;box-shadow:0 0 20px rgba(255,0,0,0.7);display:none;}
    .deck,#shop{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:20px auto;max-width:400px;}
    .card{position:relative;border-radius:12px;overflow:hidden;text-align:center;font-size:12px;cursor:pointer;background:linear-gradient(to bottom,#333,#111);border:3px solid #888;box-shadow:0 3px 8px rgba(0,0,0,0.6);padding:5px;}
    .card img{width:70%;margin:5px auto;}
    .card.selected{border:3px solid cyan;box-shadow:0 0 15px cyan;}
    .elixir-cost{position:absolute;top:5px;left:5px;background:#9c27b0;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold;border:2px solid white;}
    #battleCanvas{position:relative;background:transparent;border:3px solid white;margin-top:20px;display:block;margin-left:auto;margin-right:auto;}
    #cardBar{position:fixed;bottom:70px;left:50%;transform:translateX(-50%);display:flex;gap:10px;display:none;}
    #elixirBar{position:fixed;bottom:50px;left:50%;transform:translateX(-50%);width:300px;height:20px;border:2px solid white;border-radius:10px;background:#222;display:none;}
    #elixirFill{background:purple;width:0%;height:100%;border-radius:10px;}
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
  <!-- Top HUD -->
  <div class="top-bar">
    <div class="currency">
      <div><img src="https://img.icons8.com/emoji/48/000000/coin-emoji.png"/> <span id="coinCount">0</span></div>
    </div>
    <div id="statusText">Idle</div>
  </div>

  <!-- Menu -->
  <div id="menuScreen" class="screen" style="display:block;">
    <h2>üèÜ Flash Royale</h2>
    <p>Name: <b id="playerNameLabel"></b></p>
    <p>Your trophies: <b id="trophies">0</b></p>
    <button id="battleBtn" class="battle-btn" onclick="findMatch()">BATTLE</button>
    <button id="cancelBtn" class="cancel-btn" onclick="cancelSearch()">Cancel</button>
    <h2>Your Deck</h2><div class="deck" id="deck"></div>
    <h2>Shop</h2><div id="shop"></div>
  </div>

  <!-- Battle -->
  <div id="battleScreen" class="screen" style="display:none;">
    <canvas id="battleCanvas" width="800" height="700"></canvas>
  </div>
  <div id="cardBar"></div>
  <div id="elixirBar"><div id="elixirFill"></div></div>

  <script>
    // Firebase init
    const firebaseConfig={apiKey:"AIzaSyA3FUH9RZiQ9IRChNpGqNrgjt2r5AA5RF8",authDomain:"flash-royale-a92c0.firebaseapp.com",databaseURL:"https://flash-royale-a92c0-default-rtdb.firebaseio.com",projectId:"flash-royale-a92c0",storageBucket:"flash-royale-a92c0.appspot.com",messagingSenderId:"703977930640",appId:"1:703977930640:web:a4f70deb5bbe508aec7d15",measurementId:"G-61B7P6WEL0"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database();

    // --- Name + Player ---
    function sanitizeName(name){
      const badWords=["badword1","badword2"];
      let clean=name.replace(/[^a-zA-Z0-9]/g,"");
      if(badWords.some(w=>clean.toLowerCase().includes(w))) clean="***";
      return clean.substring(0,6);
    }
    let playerId=localStorage.getItem("playerId");
    let playerName=localStorage.getItem("playerName");
    if(!playerId){playerId="player-"+Math.floor(Math.random()*10000);localStorage.setItem("playerId",playerId);}
    if(!playerName){
      playerName=prompt("Enter your player name (max 6 chars):","");
      playerName=sanitizeName(playerName||"Anon");
      localStorage.setItem("playerName",playerName);
    }
    document.getElementById("playerNameLabel").innerText=playerName;

    let coins=0,trophies=0,ownedCards=["Knight"];
    const playerRef=db.ref("players/"+playerId);
    playerRef.once("value").then(snap=>{
      if(!snap.exists()){
        playerRef.set({name:playerName,coins:0,trophies:0,ownedCards:["Knight"]});
      }
    });
    playerRef.on("value",snap=>{
      if(snap.exists()){
        let d=snap.val();
        coins=d.coins||0;trophies=d.trophies||0;ownedCards=d.ownedCards||["Knight"];
        document.getElementById("coinCount").innerText=coins;
        document.getElementById("trophies").innerText=trophies;
        renderDeck();renderShop();
      }
    });

    // --- Cards ---
    let allCards=[
      {name:"Knight",hp:200,dmg:20,range:20,cost:3,img:"https://img.icons8.com/color/96/knight.png",price:0},
      {name:"Archer",hp:120,dmg:15,range:120,cost:3,img:"https://img.icons8.com/color/96/bow.png",price:150},
      {name:"Golem",hp:300,dmg:10,range:30,cost:5,img:"https://img.icons8.com/color/96/rock.png",price:200},
      {name:"Dragon",hp:150,dmg:30,range:80,cost:4,img:"https://img.icons8.com/color/96/dragon.png",price:300}
    ];
    function renderDeck(){let deckEl=document.getElementById("deck");deckEl.innerHTML="";ownedCards.forEach(cn=>{let c=allCards.find(x=>x.name===cn);if(c){let d=document.createElement("div");d.className="card";d.innerHTML=`<div class="elixir-cost">${c.cost}</div><img src="${c.img}"><b>${c.name}</b>`;deckEl.appendChild(d);}});}
    function renderShop(){let shop=document.getElementById("shop");shop.innerHTML="";allCards.forEach(c=>{if(!ownedCards.includes(c.name)&&c.price>0){let d=document.createElement("div");d.className="card";d.innerHTML=`<img src="${c.img}"><b>${c.name}</b><br>üí∞ ${c.price}`;d.onclick=()=>{if(coins>=c.price){coins-=c.price;ownedCards.push(c.name);playerRef.update({coins:coins,ownedCards:ownedCards});}};shop.appendChild(d);}});}

    // --- Deck / Hand ---
    let hand=[],drawPile=[],selectedCard=null;
    function initDeck(){drawPile=[...ownedCards.map(cn=>allCards.find(x=>x.name===cn))];hand=drawPile.splice(0,4);renderHand();}
    function renderHand(){let bar=document.getElementById("cardBar");bar.innerHTML="";hand.forEach(c=>{let d=document.createElement("div");d.className="card";d.innerHTML=`<div class="elixir-cost">${c.cost}</div><img src="${c.img}"><b>${c.name}</b>`;d.onclick=()=>{selectedCard=c;renderHand();d.classList.add("selected");};bar.appendChild(d);});}
    function cycleHand(card){let i=hand.indexOf(card);if(i>-1){hand.splice(i,1);if(drawPile.length>0)hand.push(drawPile.shift());}renderHand();}

    // --- Matchmaking ---
    let roomId=null,isHost=false,searching=false,loop;
    function findMatch(){document.getElementById("statusText").innerText="Searching...";document.getElementById("battleBtn").style.display="none";document.getElementById("cancelBtn").style.display="inline-block";searching=true;let queueRef=db.ref("queue");queueRef.transaction(current=>{if(!current){return {[playerId]:true};}else{let oppId=Object.keys(current)[0];roomId="room-"+Date.now();isHost=true;db.ref("rooms/"+roomId).set({players:{[playerId]:true,[oppId]:true}});return null;}},(err,committed,snap)=>{if(err){console.error(err);cancelSearch();}else if(committed){let q=snap.val();if(q&&q[playerId]){db.ref("rooms").on("child_added",snap=>{if(!searching)return;let r=snap.val();if(r.players&&r.players[playerId]&&!roomId){roomId=snap.key;startBattle();}});}else if(roomId){startBattle();}}});}
    function cancelSearch(){searching=false;db.ref("queue/"+playerId).remove();document.getElementById("statusText").innerText="Idle";document.getElementById("battleBtn").style.display="inline-block";document.getElementById("cancelBtn").style.display="none";}

    // --- Battle ---
    let placementCircle=null,units=[],towers=[],elixir=5;
    const canvas=document.getElementById("battleCanvas"),ctx=canvas.getContext("2d");

    const arenaBg=new Image();
    arenaBg.src="arena-bg.png"; // stitched background

    const towerImg=new Image();
    towerImg.src="castle-tower.png"; // mini castle tower sprite

    function startBattle(){searching=false;db.ref("queue/"+playerId).remove();document.getElementById("menuScreen").style.display="none";document.getElementById("battleScreen").style.display="block";document.getElementById("cardBar").style.display="flex";document.getElementById("elixirBar").style.display="block";document.getElementById("statusText").innerText="In Battle";document.getElementById("cancelBtn").style.display="none";initBattle();initDeck();if(isHost){loop=setInterval(updateBattleHost,200);}db.ref("rooms/"+roomId+"/state").on("value",snap=>{let s=snap.val();if(!s)return;units=s.units||[];towers=s.towers||[];elixir=s.elixir||0;drawBattle();});db.ref("rooms/"+roomId+"/actions").on("child_added",snap=>{let a=snap.val();if(a&&isHost){applyAction(a);}});}

    function initBattle(){towers=[{x:250,y:50,hp:300,maxHp:300,color:"blue",lane:"top"},{x:400,y:50,hp:300,maxHp:300,color:"blue",lane:"mid"},{x:550,y:50,hp:300,maxHp:300,color:"blue",lane:"bot"},{x:250,y:650,hp:300,maxHp:300,color:"red",lane:"top"},{x:400,y:650,hp:300,maxHp:300,color:"red",lane:"mid"},{x:550,y:650,hp:300,maxHp:300,color:"red",lane:"bot"}];units=[];elixir=5;if(isHost)db.ref("rooms/"+roomId+"/state").set({towers,units,elixir});}
    function sendAction(card,lane){db.ref("rooms/"+roomId+"/actions").push({card,player:playerId,lane});}
    function applyAction(a){spawnUnit(a.card,a.player===playerId?"ally":"enemy",a.lane);}
    function spawnUnit(card,side,lane){let dir=side==="ally"?1:-1;let color=side==="ally"?"blue":"red";let y=side==="ally"?100:600;let x=(lane==="top")?250:(lane==="mid")?400:550;let img=new Image();img.src=card.img;units.push({name:card.name,x,y,hp:card.hp,maxHp:card.hp,dmg:card.dmg,range:card.range,dir,color,cooldown:0,lane,sprite:img,animOffset:0});}
    function updateBattleHost(){elixir=Math.min(elixir+0.1,10);units.forEach(u=>{u.animOffset=Math.sin(Date.now()/150)*3;u.y+=u.dir*2;let enemies=units.filter(e=>e.color!==u.color&&e.lane===u.lane);let target=enemies.find(e=>Math.abs(e.y-u.y)<u.range);if(target){if(u.cooldown<=0){target.hp-=u.dmg;u.cooldown=20;}}if(u.cooldown>0)u.cooldown--;towers.forEach(t=>{if(t.color!==u.color&&t.lane===u.lane&&Math.abs(u.y-t.y)<40){t.hp-=u.dmg;u.hp=0;if(t.hp<=0&&t.color==="red"){endGame("blue");}if(t.hp<=0&&t.color==="blue"){endGame("red");}}});});units=units.filter(u=>u.hp>0);db.ref("rooms/"+roomId+"/state").set({towers,units,elixir});}
    function endGame(winnerColor){if(isHost){db.ref("rooms/"+roomId).remove();}clearInterval(loop);if(winnerColor==="blue"){playerRef.update({coins:coins+100,trophies:trophies+5});}alert(winnerColor+" wins!");}

    // --- Drawing ---
    function drawTower(t){if(towerImg.complete){ctx.drawImage(towerImg,t.x-30,t.y-50,60,60);}else{ctx.fillStyle=t.color;ctx.fillRect(t.x-25,t.y-25,50,50);}ctx.fillStyle="red";ctx.fillRect(t.x-25,t.y-60,50,6);ctx.fillStyle="lime";ctx.fillRect(t.x-25,t.y-60,50*(t.hp/t.maxHp),6);}
    canvas.addEventListener("mousemove",e=>{if(selectedCard){let rect=e.target.getBoundingClientRect();let x=e.clientX-rect.left;let y=e.clientY-rect.top;if(y<350){placementCircle=null;}else{placementCircle={x,y};}drawBattle();}});
    canvas.addEventListener("click",e=>{if(selectedCard&&placementCircle){let lane=(placementCircle.x<325)?"top":(placementCircle.x<475)?"mid":"bot";sendAction(selectedCard,lane);cycleHand(selectedCard);selectedCard=null;placementCircle=null;drawBattle();}});
    function drawBattle(){ctx.clearRect(0,0,800,700);if(arenaBg.complete){ctx.drawImage(arenaBg,0,0,canvas.width,canvas.height);}else{ctx.fillStyle="#6b4226";ctx.fillRect(0,0,canvas.width,canvas.height);}towers.forEach(t=>{drawTower(t);});units.forEach(u=>{if(u.sprite.complete){ctx.drawImage(u.sprite,u.x-20,u.y-20+u.animOffset,40,40);}else{ctx.fillStyle=u.color;ctx.beginPath();ctx.arc(u.x,u.y,12,0,Math.PI*2);ctx.fill();}let barWidth=40;let hpPercent=Math.max(u.hp,0)/u.maxHp;ctx.fillStyle="red";ctx.fillRect(u.x-20,u.y-30,barWidth,5);ctx.fillStyle="lime";ctx.fillRect(u.x-20,u.y-30,barWidth*hpPercent,5);});if(placementCircle){ctx.strokeStyle="white";ctx.beginPath();ctx.arc(placementCircle.x,placementCircle.y,25,0,Math.PI*2);ctx.stroke();}}

    // --- Cleanup on
