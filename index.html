<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flash Royale</title>
  <style>
    body {
      margin:0; font-family:Arial, sans-serif;
      color:white; user-select:none;
      background:url('castle-bg.png') no-repeat center center fixed;
      background-size:cover;
    }
    .top-bar { display:flex; justify-content:space-between; align-items:center;
      padding:10px 20px; background:rgba(10,15,30,0.9);
      border-bottom:3px solid #1e3d59; font-size:14px; }
    .tabs { position:fixed; bottom:0; left:0; width:100%;
      display:flex; justify-content:space-around;
      background:rgba(10,15,30,0.95); border-top:3px solid #1e3d59;
      padding:10px 0; }
    .tab { text-align:center; flex:1; cursor:pointer; font-size:14px; padding:5px; }
    .tab img { width:28px; display:block; margin:auto; }
    .tab:hover { background:#1e3d59; }
    .screen { display:none; padding:20px; text-align:center; }
    #battleCanvas { background:#2a2a2a; border:3px solid white; margin-top:20px; }
    #battleScreen .battle-btn {
      background:#ffcc00; padding:10px 20px; border-radius:12px;
      font-size:20px; color:black; cursor:pointer; margin:10px;
      border:2px solid #fff; box-shadow:0 0 10px rgba(255,255,0,0.6);
    }
  </style>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js"></script>
</head>
<body>

  <!-- Top HUD -->
  <div class="top-bar">
    <div>âš¡ Flash Royale</div>
    <div id="statusText">Disconnected</div>
  </div>

  <!-- Screens -->
  <div id="battleScreen" class="screen" style="display:block;">
    <h2>Battle Lobby</h2>
    <input id="roomInput" placeholder="Enter Room Name" style="padding:8px;border-radius:6px;border:none;">
    <button class="battle-btn" onclick="joinRoom()">Join/Create Room</button>
    <div id="roomStatus"></div>
    <div id="startBtn" class="battle-btn" style="display:none;" onclick="startBattle()">START BATTLE</div>

    <canvas id="battleCanvas" width="800" height="500" style="display:none;"></canvas>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab" onclick="switchScreen('battleScreen')">
      <img src="https://img.icons8.com/ios/50/ffffff/swords.png"/>Battle
    </div>
  </div>

  <script>
    // --- Firebase Init ---
    const firebaseConfig = {
      apiKey: "AIzaSyA3FUH9RZiQ9IRChNpGqNrgjt2r5AA5RF8",
      authDomain: "flash-royale-a92c0.firebaseapp.com",
      databaseURL: "https://flash-royale-a92c0-default-rtdb.firebaseio.com",
      projectId: "flash-royale-a92c0",
      storageBucket: "flash-royale-a92c0.firebasestorage.app",
      messagingSenderId: "703977930640",
      appId: "1:703977930640:web:a4f70deb5bbe508aec7d15",
      measurementId: "G-61B7P6WEL0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // --- Game Vars ---
    let roomId=null, playerId="player-"+Math.floor(Math.random()*10000);
    let towers=[], units=[], ctx;
    let loop=null;

    // --- UI Switcher ---
    function switchScreen(id){
      document.querySelectorAll('.screen').forEach(s=>s.style.display='none');
      document.getElementById(id).style.display='block';
    }

    // --- Room Join ---
    function joinRoom(){
      roomId=document.getElementById("roomInput").value.trim();
      if(!roomId){ alert("Enter a room name!"); return; }
      db.ref(`rooms/${roomId}/players/${playerId}`).set({joined:true});
      document.getElementById("roomStatus").innerText="Joined room: "+roomId+" as "+playerId;
      db.ref(`rooms/${roomId}/players`).on("value",(snap)=>{
        let players=snap.val();
        if(players && Object.keys(players).length>=2){
          document.getElementById("startBtn").style.display="block";
        }
      });
    }

    // --- Start Battle ---
    function startBattle(){
      document.getElementById("battleCanvas").style.display="block";
      ctx=document.getElementById("battleCanvas").getContext("2d");
      initBattle();
      loop=setInterval(updateBattle,50);

      // Sync opponent actions
      db.ref(`rooms/${roomId}/lastAction`).on("value",(snap)=>{
        let action=snap.val();
        if(action && action.player!==playerId){
          spawnUnit(action.card, "enemy");
        }
      });

      // Keybind: press 1-4 to play a troop
      document.addEventListener("keydown",(e)=>{
        if(e.key==="1") sendAction({name:"Knight", hp:200, dmg:20, range:20});
        if(e.key==="2") sendAction({name:"Archer", hp:120, dmg:15, range:120});
        if(e.key==="3") sendAction({name:"Golem", hp:300, dmg:10, range:30});
        if(e.key==="4") sendAction({name:"Dragon", hp:150, dmg:30, range:80});
      });
    }

    function sendAction(card){
      db.ref(`rooms/${roomId}/lastAction`).set({
        type:"playCard", card, player:playerId, timestamp:Date.now()
      });
      spawnUnit(card,"ally");
    }

    // --- Battlefield ---
    function initBattle(){
      towers=[
        {x:100,y:200,hp:500,color:"blue"},
        {x:700,y:150,hp:300,color:"red"},
        {x:700,y:350,hp:300,color:"red"},
        {x:750,y:250,hp:600,color:"red"} // enemy king
      ];
      units=[];
    }

    function spawnUnit(card,side){
      let dir=side==="ally"?1:-1;
      let color=side==="ally"?"blue":"red";
      let x=side==="ally"?150:650;
      units.push({
        name:card.name,x,y:250,hp:card.hp,dmg:card.dmg,range:card.range,
        dir,color,cooldown:0
      });
    }

    function updateBattle(){
      ctx.clearRect(0,0,800,500);

      // Draw towers
      towers.forEach(t=>{
        ctx.fillStyle=t.color;
        ctx.fillRect(t.x,t.y,40,60);
        ctx.fillStyle="white";
        ctx.fillText("HP:"+t.hp, t.x, t.y-10);
      });

      // Units
      units.forEach(u=>{
        ctx.fillStyle=u.color;
        ctx.beginPath();
        ctx.arc(u.x,u.y,10,0,Math.PI*2);
        ctx.fill();

        // Look for enemy in range
        let enemies=units.filter(e=>e.color!==u.color);
        let target=enemies.find(e=>Math.abs(e.x-u.x)<u.range);
        if(target){
          if(u.cooldown<=0){
            target.hp-=u.dmg;
            u.cooldown=20;
          }
        } else {
          // Move if no target
          u.x+=u.dir*2;
        }

        if(u.cooldown>0) u.cooldown--;

        // Check tower collisions
        towers.forEach(t=>{
          if(t.color!==u.color && Math.abs(u.x-t.x)<30 && Math.abs(u.y-t.y)<50){
            t.hp-=u.dmg;
            u.hp=0;
            if(t.hp<=0){
              alert((u.color==="blue"?"Blue":"Red")+" wins!");
              clearInterval(loop);
            }
          }
        });
      });

      // Remove dead units
      units=units.filter(u=>u.hp>0);
    }
  </script>
</body>
</html>
