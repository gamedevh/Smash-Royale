<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flash Royale</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      width: 100%;
      height: 100%;
      color: white;
      user-select: none;
      overflow: hidden;
      background: url('menu-bg.png') no-repeat center center fixed;
      background-size: cover;
    }
    .top-bar{display:flex;justify-content:space-between;align-items:center;padding:10px 20px;background:rgba(10,15,30,0.7);border-bottom:3px solid #1e3d59;font-size:14px;}
    .currency{display:flex;gap:15px;}
    .currency div{background:#2d3e50;padding:5px 12px;border-radius:8px;display:flex;align-items:center;gap:5px;}
    #onlineCount { margin-left: 15px; font-weight: bold; }
    .screen{display:none;height:100vh;}
    #menuScreen { display: block; text-align: center; }
    #battleScreen { text-align: center; display:none; position:relative; }
    .battle-btn{background:#ffcc00;padding:20px 60px;border-radius:20px;font-size:32px;color:black;cursor:pointer;margin-top:20px;border:3px solid #fff;box-shadow:0 0 25px rgba(255,255,0,0.9);}
    .cancel-btn{background:#ff4444;padding:15px 40px;border-radius:15px;font-size:24px;color:white;cursor:pointer;margin-top:20px;border:3px solid #fff;box-shadow:0 0 20px rgba(255,0,0,0.7);display:none;}
    .deck{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:20px auto;max-width:400px;}
    .card{position:relative;border-radius:12px;overflow:hidden;text-align:center;font-size:12px;cursor:pointer;background:linear-gradient(to bottom,#333,#111);border:3px solid #888;box-shadow:0 3px 8px rgba(0,0,0,0.6);padding:5px;}
    .card img{width:70%;margin:5px auto;}
    .card.selected{border:3px solid cyan;box-shadow:0 0 15px cyan;}
    .elixir-cost{position:absolute;top:5px;left:5px;background:#9c27b0;border-radius:50%;width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:bold;border:2px solid white;}
    #arenaBackground {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      z-index: 0;
    }
    #battleCanvas {
      position: relative;
      background: transparent;
      border: 3px solid white;
      margin-top: 20px;
      display: block;
      margin-left: auto;
      margin-right: auto;
      z-index: 1;
    }
    #cardBar{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);display:flex;gap:10px;display:none;}
    #elixirBar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      width: 500px;
      height: 24px;
      border: 2px solid white;
      border-radius: 10px;
      background: #222;
      display: none;
      justify-content: space-between;
      padding: 2px;
    }
    .elixir-segment { flex: 1; margin: 0 1px; background: #444; border-radius: 4px; }
    .elixir-filled { background: purple; }

    /* Victory/Defeat banner */
    #resultScreen {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      color: white;
      text-align: center;
      font-size: 32px;
      padding-top: 200px;
      z-index: 10;
    }
    #resultScreen button {
      margin-top: 30px;
      padding: 15px 40px;
      font-size: 20px;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      background: gold;
      color: black;
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
</head>
<body>
  <!-- Top HUD -->
  <div class="top-bar">
    <div class="currency">
      <div><img src="https://img.icons8.com/emoji/48/000000/coin-emoji.png"/> <span id="coinCount">0</span></div>
    </div>
    <div>
      <span id="statusText">Idle</span>
      <span id="onlineCount">Online: 0</span>
    </div>
  </div>

  <!-- Menu -->
  <div id="menuScreen" class="screen">
    <h2>üèÜ Flash Royale</h2>
    <p>Name: <b id="playerNameLabel"></b></p>
    <p>Your trophies: <b id="trophies">0</b></p>
    <button id="battleBtn" class="battle-btn" onclick="findMatch()">BATTLE</button>
    <button id="cancelBtn" class="cancel-btn" onclick="cancelSearch()">Cancel</button>
    <h2>Your Deck</h2><div class="deck" id="deck"></div>
  </div>

  <!-- Battle -->
  <div id="battleScreen" class="screen">
    <img id="arenaBackground" src="arena-bg.png" width="800" height="700"/>
    <canvas id="battleCanvas" width="800" height="700"></canvas>
  </div>
  <div id="cardBar"></div>
  <div id="elixirBar"></div>

  <!-- Result Screen -->
  <div id="resultScreen">
    <h1 id="resultText"></h1>
    <p id="rewardText"></p>
    <button onclick="returnToMenu()">OK</button>
  </div>

  <script>
    // Firebase init
    const firebaseConfig={apiKey:"AIzaSyA3FUH9RZiQ9IRChNpGqNrgjt2r5AA5RF8",authDomain:"flash-royale-a92c0.firebaseapp.com",databaseURL:"https://flash-royale-a92c0-default-rtdb.firebaseio.com",projectId:"flash-royale-a92c0",storageBucket:"flash-royale-a92c0.appspot.com",messagingSenderId:"703977930640",appId:"1:703977930640:web:a4f70deb5bbe508aec7d15",measurementId:"G-61B7P6WEL0"};
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database();

    const towerImg=new Image();towerImg.src="mini-castle.png";

    // Player
    let playerId=localStorage.getItem("playerId");
    let playerName=localStorage.getItem("playerName");
    if(!playerId){playerId="player-"+Math.floor(Math.random()*10000);localStorage.setItem("playerId",playerId);}
    if(!playerName){playerName=prompt("Enter your player name (max 6 chars):","Anon").substring(0,6);localStorage.setItem("playerName",playerName);}
    document.getElementById("playerNameLabel").innerText=playerName;

    const playerRef=db.ref("players/"+playerId);
    playerRef.once("value").then(snap=>{
      if(!snap.exists()){
        playerRef.set({name:playerName,online:true,coins:0,trophies:0});
      } else { playerRef.update({online:true}); }
    });
    window.addEventListener("beforeunload",()=>{playerRef.update({online:false});});

    // Online counter
    db.ref("players").on("value",snap=>{
      let online=0;snap.forEach(c=>{if(c.val().online)online++;});
      document.getElementById("onlineCount").innerText="Online: "+online;
    });

    // Deck
    let deck=[
      {name:"Knight",hp:200,maxHp:200,dmg:20,range:20,cost:3,speed:2,img:"https://img.icons8.com/color/96/knight.png"},
      {name:"Archer",hp:120,maxHp:120,dmg:15,range:120,cost:3,speed:2,img:"https://img.icons8.com/color/96/bow.png"},
      {name:"Golem",hp:400,maxHp:400,dmg:30,range:20,cost:6,speed:1,img:"https://img.icons8.com/color/96/rock.png"},
      {name:"Dragon",hp:150,maxHp:150,dmg:40,range:100,cost:5,speed:3,img:"https://img.icons8.com/color/96/dragon.png"}
    ];

    function renderDeck(){
      let deckEl=document.getElementById("deck");deckEl.innerHTML="";
      deck.forEach(c=>{
        let d=document.createElement("div");d.className="card";
        d.innerHTML=`<div class="elixir-cost">${c.cost}</div><img src="${c.img}"><b>${c.name}</b>`;
        deckEl.appendChild(d);
      });
    }
    renderDeck();

    // Elixir
    let elixir=0,maxElixir=10,elixirRegenRate=2000,lastElixirTime=Date.now();
    function initElixirBar(){let bar=document.getElementById("elixirBar");bar.innerHTML="";for(let i=0;i<maxElixir;i++){let seg=document.createElement("div");seg.className="elixir-segment";seg.id="elixir-"+i;bar.appendChild(seg);}}
    function updateElixir(){let now=Date.now();if(now-lastElixirTime>=elixirRegenRate&&elixir<maxElixir){elixir++;lastElixirTime=now;}for(let i=0;i<maxElixir;i++){let seg=document.getElementById("elixir-"+i);if(i<elixir){seg.classList.add("elixir-filled");}else{seg.classList.remove("elixir-filled");}}}
    setInterval(updateElixir,500);

    // Matchmaking
    let roomId=null,isHost=false,searching=false;
    function findMatch(){document.getElementById("statusText").innerText="Searching...";document.getElementById("battleBtn").style.display="none";document.getElementById("cancelBtn").style.display="inline-block";searching=true;let qRef=db.ref("queue");qRef.once("value").then(snap=>{let q=snap.val();if(q){let oppId=Object.keys(q)[0];roomId="room-"+Date.now();isHost=true;db.ref("rooms/"+roomId).set({players:{[playerId]:true,[oppId]:true}});db.ref("queue/"+oppId).remove();startBattle();}else{db.ref("queue/"+playerId).set(true);db.ref("rooms").on("child_added",snap=>{if(!searching)return;let r=snap.val();if(r.players&&r.players[playerId]&&!roomId){roomId=snap.key;startBattle();}});}});}
    function cancelSearch(){searching=false;db.ref("queue/"+playerId).remove();document.getElementById("statusText").innerText="Idle";document.getElementById("battleBtn").style.display="inline-block";document.getElementById("cancelBtn").style.display="none";}

    // Battle
    let canvas=document.getElementById("battleCanvas"),ctx=canvas.getContext("2d");
    let towers=[],units=[],selectedCard=null;

    function startBattle(){
      searching=false;db.ref("queue/"+playerId).remove();
      document.getElementById("menuScreen").style.display="none";
      document.getElementById("battleScreen").style.display="block";
      document.getElementById("cardBar").style.display="flex";
      document.getElementById("elixirBar").style.display="flex";
      document.getElementById("arenaBackground").style.display="block";
      document.getElementById("statusText").innerText="In Battle";
      elixir=5;lastElixirTime=Date.now();initElixirBar();
      towers=[
        {x:150,y:550,hp:600,side:"blue",king:false},
        {x:650,y:550,hp:600,side:"blue",king:false},
        {x:400,y:620,hp:1000,side:"blue",king:true},
        {x:150,y:150,hp:600,side:"red",king:false},
        {x:650,y:150,hp:600,side:"red",king:false},
        {x:400,y:80,hp:1000,side:"red",king:true}
      ];
      requestAnimationFrame(drawBattle);
      db.ref("rooms/"+roomId+"/players/"+playerId).set(true);
    }

    function spawnUnit(card,side,x,y){
      units.push({...card,side,x,y,hp:card.hp,maxHp:card.hp,cooldown:0,dir:(side==="blue"?-1:1)});
    }

    canvas.addEventListener("click",e=>{
      if(!selectedCard)return;
      let rect=canvas.getBoundingClientRect();let x=e.clientX-rect.left;let y=e.clientY-rect.top;
      if(y<canvas.height/2)return;
      if(elixir>=selectedCard.cost){spawnUnit(selectedCard,"blue",x,y);elixir-=selectedCard.cost;selectedCard=null;}
    });

    function drawTower(t){if(towerImg.complete){ctx.drawImage(towerImg,t.x-25,t.y-25,50,50);}else{ctx.fillStyle=t.side==="blue"?"blue":"red";ctx.fillRect(t.x-20,t.y-20,40,40);}ctx.fillStyle="red";ctx.fillRect(t.x-20,t.y-35,40,5);ctx.fillStyle="lime";let hpWidth=Math.max(0,(t.hp/1000)*40);ctx.fillRect(t.x-20,t.y-35,hpWidth,5);}
    function drawUnit(u){ctx.fillStyle=u.side==="blue"?"cyan":"red";ctx.beginPath();ctx.arc(u.x,u.y,15,0,Math.PI*2);ctx.fill();ctx.fillStyle="red";ctx.fillRect(u.x-15,u.y-25,30,5);ctx.fillStyle="lime";ctx.fillRect(u.x-15,u.y-25,30*(u.hp/u.maxHp),5);}
    function updateUnits(){units.forEach(u=>{u.y+=u.dir*u.speed;if(u.cooldown>0)u.cooldown--;towers.forEach(t=>{if(t.side!==u.side&&Math.abs(u.x-t.x)<30&&Math.abs(u.y-t.y)<30){if(u.cooldown<=0){t.hp-=u.dmg;u.cooldown=30;}}});});units=units.filter(u=>u.hp>0);}
    function drawBattle(){ctx.clearRect(0,0,canvas.width,canvas.height);towers.forEach(t=>{drawTower(t);if(t.hp<=0&&t.king){endGame(t.side==="blue"?"Red":"Blue");}});updateUnits();units.forEach(u=>drawUnit(u));requestAnimationFrame(drawBattle);}

    function endGame(winner){document.getElementById("resultText").innerText=winner+" Wins!";document.getElementById("rewardText").innerText=(winner==="Blue"&&isHost||winner==="Red"&&!isHost)?"+100 Coins, +5 Trophies":"Defeat";document.getElementById("resultScreen").style.display="block";db.ref("rooms/"+roomId).remove();}
    function returnToMenu(){document.getElementById("resultScreen").style.display="none";document.getElementById("battleScreen").style.display="none";document.getElementById("menuScreen").style.display="block";document.getElementById("arenaBackground").style.display="none";document.getElementById("cardBar").style.display="none";document.getElementById("elixirBar").style.display="none";document.getElementById("statusText").innerText="Idle";}
  </script>
</body>
</html>
